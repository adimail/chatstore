(()=>{"use strict";({139:function(){var e=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))((function(o,s){function a(e){try{l(r.next(e))}catch(e){s(e)}}function i(e){try{l(r.throw(e))}catch(e){s(e)}}function l(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,i)}l((r=r.apply(e,t||[])).next())}))};document.addEventListener("DOMContentLoaded",(function(){const t=document.getElementById("chat-page-container"),n=document.getElementById("chat-output"),r=document.getElementById("history-messages"),o=document.getElementById("message-input"),s=document.getElementById("send-button"),a=document.getElementById("loading-indicator"),i=document.getElementById("clear-history-button"),l=document.getElementById("load-more-button-sidebar"),d=document.getElementById("no-history-sidebar-msg"),c=document.getElementById("chat-main-area");if(!t)return void console.error("Chat page container not found");const u=t.dataset.chatUrl||"",y=t.dataset.loadMoreUrl||"",h=t.dataset.clearHistoryUrl||"";let f=parseInt(t.dataset.currentOffset||"0",10);const g=parseInt(t.dataset.initialLimit||"10",10);let m=parseInt(t.dataset.totalMessages||"0",10),p=!1;function E(e,t){const n=document.createElement("div");n.classList.add("user"===t?"user-message":"agent-message");const r=document.createElement("div");r.classList.add("message-bubble");const o=document.createElement("span");return o.innerHTML=e.replace(/\n/g,"<br>"),r.appendChild(o),n.appendChild(r),n}function b(e,t){if(!n)return;const r=E(e,t);n.appendChild(r),n.scrollTop=n.scrollHeight,c&&"transparent"!==c.style.backgroundColor&&(c.style.backgroundColor="#f8f9fa")}function v(e,t,n=!0){if(!r)return;const o=E(e,t);n?(r.prepend(o),r.scrollTop=0):r.appendChild(o),d&&"none"!==d.style.display&&(d.style.display="none")}function L(){return e(this,void 0,void 0,(function*(){if(!o)return;const e=o.value.trim();if(e){b(e,"user"),v(e,"user",!0),o&&(o.value=""),s&&(s.disabled=!0),o&&(o.disabled=!0),a&&(a.style.display="block");try{if(!u)throw new Error("Chat URL is not defined");const t=yield fetch(u,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e})});let n;try{n=yield t.json()}catch(e){const t="Error: Could not parse server response.";return b(t,"agent"),v(t,"agent",!0),void console.error("Parsing error:",e)}if(t.ok)n.response&&(b(n.response,"agent"),v(n.response,"agent",!0));else{const e=n.error||`Error: ${t.statusText}`;b(e,"agent"),v(e,"agent",!0)}}catch(e){const t="Network error. Please try again.";b(t,"agent"),v(t,"agent",!0),console.error("Network/Fetch error:",e)}finally{s&&(s.disabled=!1),o&&(o.disabled=!1),a&&(a.style.display="none"),o&&o.focus(),m+=2,f+=2}}}))}n&&(n.scrollTop=n.scrollHeight),r&&(r.scrollTop=0),s&&s.addEventListener("click",L),o&&(o.addEventListener("keypress",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),L())})),o.focus()),i&&i.addEventListener("click",(function(){return e(this,void 0,void 0,(function*(){if(confirm("Are you sure you want to clear all chat history? This cannot be undone."))try{if(!h)throw new Error("Clear history URL is not defined");const e=yield fetch(h,{method:"POST"}),t=yield e.json();if(e.ok&&t.success){if(n){const e=n.querySelector(".initial-greeting");n.innerHTML="",e&&n.appendChild(e),n.scrollTop=n.scrollHeight}r&&(r.innerHTML="",d&&(r.appendChild(d),d.style.display="block")),f=0,m=0,l&&(l.style.display="none"),alert(t.message||"Chat history cleared.")}else alert(t.message||"Failed to clear chat history.")}catch(e){console.error("Error clearing chat history:",e),alert("An error occurred while clearing chat history.")}}))})),l&&l.addEventListener("click",(function(){return e(this,void 0,void 0,(function*(){if(!p){p=!0,a&&(a.style.display="block"),l&&(l.disabled=!0);try{if(!y)throw new Error("Load more URL is not defined");const e=yield fetch(`${y}?offset=${f}&limit=${g}`),t=yield e.json();e.ok&&t.messages?(t.messages.forEach((e=>{v(e.message_text,e.sender,!1)})),f+=t.messages.length,(t.messages.length<g||f>=m)&&l&&(l.style.display="none")):console.error("Failed to load more messages for sidebar:",t.error)}catch(e){console.error("Error loading more sidebar messages:",e)}finally{p=!1,a&&(a.style.display="none"),l&&(l.disabled=!1)}}}))}))}))}})[139]()})();